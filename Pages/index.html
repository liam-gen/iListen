<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>iListen - Accueil</title>
  <link rel="stylesheet" href="../assets/css/default.css">
  <link rel="stylesheet" href="../assets/css/modal.css">
  <link rel="stylesheet" href="../assets/css/main.css">

  <script src="../assets/libraries/tingle/index.min.js"></script>
  <link rel="stylesheet" href="../assets/libraries/tingle/style.min.css"/>

  <script src="../Classes/DatabaseManager.js"></script>
  
</head>
<body>
  <div class="playlists">

  </div>

  <div class="status"></div>

  <div class="wrapper">
    <button id="clear-cache">Vider le cache</button>
    <button id="create-playlist">Créer une playlist</button>
</div>



<script>
let db = new Database();

let path = require("path")

function getFilesizeInBytes(filename) {
    var stats = fs.statSync(filename);
    var fileSizeInBytes = stats.size;
    return fileSizeInBytes;
}



const getDirSize = (dirPath) => {
  let size = 0;
  const files = fs.readdirSync(dirPath);

  for (let i = 0; i < files.length; i++) {
    const filePath = path.join(dirPath, files[i]);
    const stats = fs.statSync(filePath);

    if (stats.isFile()) {
      size += stats.size;
    } else if (stats.isDirectory()) {
      size += getDirSize(filePath);
    }
  }

  return size;
};

function humanFileSize(bytes, si=true, dp=1) {
  const thresh = si ? 1000 : 1024;

  if (Math.abs(bytes) < thresh) {
    return bytes + ' B';
  }

  const units = si 
    ? ['kB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'] 
    : ['KiB', 'MiB', 'GiB', 'TiB', 'PiB', 'EiB', 'ZiB', 'YiB'];
  let u = -1;
  const r = 10**dp;

  do {
    bytes /= thresh;
    ++u;
  } while (Math.round(Math.abs(bytes) * r) / r >= thresh && u < units.length - 1);


  return bytes.toFixed(dp) + ' ' + units[u];
}

let clearButton = document.getElementById('clear-cache');

let cacheSize = getFilesizeInBytes(require('@electron/remote').app.getPath("userData") + "/Data/songs.json") + getDirSize(require('@electron/remote').app.getPath("userData") + "/Data/downloads");

clearButton.innerHTML = "Vider le cache ("+humanFileSize(cacheSize)+")"

clearButton.onclick = function(){
    fs.writeFileSync(require('@electron/remote').app.getPath("userData") + "/Data/songs.json", "{}")

    fs.rmSync(require('@electron/remote').app.getPath("userData") + "/Data/downloads", {recursive: true});

    fs.mkdirSync(require('@electron/remote').app.getPath("userData") + "/Data/downloads");

    clearButton.innerHTML = "Vider le cache ("+humanFileSize(getFilesizeInBytes(require('@electron/remote').app.getPath("userData") + "/Data/songs.json") + getDirSize(require('@electron/remote').app.getPath("userData") + "/Data/downloads"))+")"
}
/* LOAD PLAYLISTS */

let wrapper = document.querySelector(".playlists")

db.getPlaylists().then(elements => {
    elements.forEach((playlist) => {
        let element = document.createElement("div");
        element.innerHTML = playlist["name"];
        element.addEventListener("click", () => {
            window.location.href = "playlist.html?id="+playlist["ID"]
        })
        wrapper.appendChild(element);
    })
})

var modal = new tingle.modal({
    footer: true,
    stickyFooter: false,
    closeMethods: ['button', 'escape'],
    closeLabel: "Fermer",
});

document.getElementById("create-playlist").onclick = function(){
    modal.open()
}

modal.setContent(`
    <h1>Créer une playlist</h1>
    <p>
        Entrez le nom de votre playlist
    </p>
    <input id="playlist-name" type="text" placeholder="Nom de la playlist...">
`);

modal.addFooterBtn('Créer', 'tingle-btn tingle-btn--primary', function() {

    const playlistName = document.getElementById("playlist-name").value;

    db.createPlaylist(playlistName).then(() => {
        location.reload()
    })
});

modal.addFooterBtn('Annuler', 'tingle-btn tingle-btn--danger', function() {
    modal.close();
});

const {ipcRenderer} = require('electron');
ipcRenderer.on('message', function(event, text) {
 document.querySelector(".status").innerHTML = text
})

</script>

</body>
</html>